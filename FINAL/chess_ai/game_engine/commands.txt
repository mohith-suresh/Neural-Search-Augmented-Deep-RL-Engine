# 1. Update lists (Ubuntu repos rarely break like Debian's)
sudo apt update

# 2. Install NVIDIA Drivers (Automatic)
sudo apt install -y ubuntu-drivers-common
sudo ubuntu-drivers autoinstall

# 3. Reboot to load drivers
sudo reboot

nvidia-smi

echo "================= SYSTEM CONTEXT ================="
echo "[1. CPU Info]"
echo "Logical Cores: $(nproc)"
lscpu | grep -E 'Model name|Thread\(s\) per core|Core\(s\) per socket'

echo -e "\n[2. Memory Info]"
free -h | grep Mem

echo -e "\n[3. GPU Info]"
if command -v nvidia-smi &> /dev/null; then
    nvidia-smi --query-gpu=name,memory.total,memory.free,compute_cap --format=csv
else
    echo "No GPU found or driver not installed."
fi

echo -e "\n[4. Disk Space]"
df -h . | awk 'NR==2 {print "Available: "$4 " / Used: "$3}'
echo "=================================================="

# Install dependencies
sudo apt install -y python3-pip git tmux stockfish nvtop

pip3 install torch numpy python-chess gdown matplotlib --break-system-packages

echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
echo $PATH

# Setup project and start training

git clone https://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@github.com/krish-modi1/EE542-Project.git
cd EE542-Project/FINAL/chess_ai

git config --global user.email "krish.modi.2000@gmail.com"
git config --global user.name "Krish Modi"

https://drive.google.com/file/d/15sW8KpButGdBVufwZYmrcvyGkcDL8pde/view?usp=sharing

# Download your model
gdown "15sW8KpButGdBVufwZYmrcvyGkcDL8pde" -O game_engine/model/best_model.pth

python3 game_engine/migrate_model.py

# Install nvtop
nvtop

# Run training
nohup python3 -u game_engine/main.py > /dev/null 2>&1 &
tail -f training_log.txt

# To kill the loop

ps -ef | grep python
ps aux | grep main.py
kill -TERM <pid>

# force kill

# See what's running
ps -u "$USER" | grep python
watch -n 1 "ps -ef | grep python | grep -v grep"

# Then nuke all your userâ€™s python processes (no grace)
killall -9 python3 python || pkill -9 -u "$USER" python3

pkill -9 -f "game_engine/main.py"

# Absolute PATH

/home/krishmod/EE542-Project/FINAL/chess_ai/training_log.txt
/home/krishmod/EE542-Project/FINAL/chess_ai/game_engine/model/best_model.pth

# on cloud push

git pull
git add .
git commit -m "update metrics.json"
git push

# --- PATHS ---
STOCKFISH_PATH = "/usr/games/stockfish" 
LOG_FILE = "training_log.txt"
MODEL_DIR = "game_engine/model"
DATA_DIR = "data/self_play"
BEST_MODEL = f"{MODEL_DIR}/best_model.pth"
CANDIDATE_MODEL = f"{MODEL_DIR}/candidate.pth"

# --- CUDA ---
CUDA_TIMEOUT_INFERENCE = 0.01 
CUDA_STREAMS = 8 

# --- EXECUTION ---
ITERATIONS = 1000
NUM_WORKERS = 64            
WORKER_BATCH_SIZE = 8       
GAMES_PER_WORKER = 5        

# --- QUALITY ---
SIMULATIONS = 1200           
EVAL_SIMULATIONS = 1200      

# --- EVALUATION CONFIG ---
EVAL_WORKERS = 10           
GAMES_PER_EVAL_WORKER = 2   
STOCKFISH_GAMES = 20
SF_WORKERS = 10              
SF_GAMES_PER_WORKER = 2     
STOCKFISH_ELO = 1350        

# --- RULES ---
MAX_MOVES_PER_GAME = 120   
EVAL_MAX_MOVES_PER_GAME = 140 
current_iter = get_start_iteration(DATA_DIR) - 1
if current_iter < 10:
    DRAW_PENALTY = -0.15
elif current_iter < 20:
    DRAW_PENALTY = -0.30
else:
    DRAW_PENALTY = -0.40        

# Training
TRAIN_EPOCHS = 1 
TRAIN_WINDOW = 20           
TRAIN_BATCH_SIZE = 1024      
TRAIN_LR = 0.0001           