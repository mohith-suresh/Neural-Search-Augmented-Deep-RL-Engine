<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess AI - AlphaZero</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        h1 {
            grid-column: 1 / -1;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 700;
        }

        .board-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .board-wrapper {
            position: relative;
            background: #8B7355;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 3px solid #5D4E37;
            padding: 8px;
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0;
            aspect-ratio: 1;
            background: #A0826D;
            border-radius: 4px;
            overflow: hidden;
        }

        .square {
            width: 100%;
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            position: relative;
            border: 1px solid #3e2723;
            transition: all 0.15s ease;
            user-select: none;
        }

        /* Light squares - explicit pattern for 8x8 board */
        .square:nth-child(1), .square:nth-child(3), .square:nth-child(5), .square:nth-child(7),
        .square:nth-child(10), .square:nth-child(12), .square:nth-child(14), .square:nth-child(16),
        .square:nth-child(17), .square:nth-child(19), .square:nth-child(21), .square:nth-child(23),
        .square:nth-child(26), .square:nth-child(28), .square:nth-child(30), .square:nth-child(32),
        .square:nth-child(33), .square:nth-child(35), .square:nth-child(37), .square:nth-child(39),
        .square:nth-child(42), .square:nth-child(44), .square:nth-child(46), .square:nth-child(48),
        .square:nth-child(49), .square:nth-child(51), .square:nth-child(53), .square:nth-child(55),
        .square:nth-child(58), .square:nth-child(60), .square:nth-child(62), .square:nth-child(64) {
            background-color: #F0D9B5;
        }

        /* Dark squares - explicit pattern for 8x8 board */
        .square:nth-child(2), .square:nth-child(4), .square:nth-child(6), .square:nth-child(8),
        .square:nth-child(9), .square:nth-child(11), .square:nth-child(13), .square:nth-child(15),
        .square:nth-child(18), .square:nth-child(20), .square:nth-child(22), .square:nth-child(24),
        .square:nth-child(25), .square:nth-child(27), .square:nth-child(29), .square:nth-child(31),
        .square:nth-child(34), .square:nth-child(36), .square:nth-child(38), .square:nth-child(40),
        .square:nth-child(41), .square:nth-child(43), .square:nth-child(45), .square:nth-child(47),
        .square:nth-child(50), .square:nth-child(52), .square:nth-child(54), .square:nth-child(56),
        .square:nth-child(57), .square:nth-child(59), .square:nth-child(61), .square:nth-child(63) {
            background-color: #B58863;
        }

        .square.selected {
            background-color: #BACA44 !important;
            border-color: #BACA44;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .square.legal-move {
            box-shadow: inset 0 0 0 3px #52B051;
        }

        .square.legal-move::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #52B051;
            border-radius: 50%;
            opacity: 0.6;
            box-shadow: 0 0 3px rgba(82, 176, 81, 0.5);
        }

        .square.last-move {
            background-color: #BACA44 !important;
            box-shadow: inset 0 0 0 2px #999;
        }

        .square:hover {
            filter: brightness(1.08);
        }

        .piece {
            font-size: 52px;
            line-height: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            user-select: none;
            filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.3));
            font-weight: bold;
        }

        .piece.white {
            color: #FFFFFF;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            font-weight: 900;
        }

        .piece.black {
            color: #000000;
            text-shadow: 0px 0px 2px rgba(255, 255, 255, 0.3);
        }

        .timer {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .timer.warning {
            background: linear-gradient(135deg, #fed7d7 0%, #fc8181 100%);
            color: #742a2a;
            animation: timerWarning 0.5s ease infinite;
            border-color: #f56565;
        }

        @keyframes timerWarning {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.3);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(245, 101, 101, 0);
            }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            grid-column: 1 / -1;
        }

        button {
            flex: 1;
            min-width: 100px;
            padding: 12px 16px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: scale(0.96);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #5568d3 0%, #4555c0 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #52B051 0%, #449D44 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #449D44 0%, #388838 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(82, 176, 81, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #C0392B 0%, #A93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7a7d 100%);
            transform: translateY(-2px);
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-left: 4px solid #667eea;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .panel h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .stat-value {
            color: #667eea;
            font-weight: 700;
        }

        .move-history {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            max-height: 220px;
            overflow-y: auto;
            font-size: 13px;
        }

        .move-item {
            padding: 6px 10px;
            background: #f5f5f5;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            font-weight: 500;
        }

        .status {
            padding: 14px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.show {
            display: block;
        }

        .status.info {
            background: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
        }

        .status.success {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .status.error {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .status.warning {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEEBA;
        }

        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .connection-status.connected {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .connection-status.disconnected {
            background: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .promotion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .promotion-modal.show {
            display: flex;
        }

        .promotion-box {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .promotion-box h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .promotion-options {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .promotion-piece {
            font-size: 50px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .promotion-piece:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.1);
        }

        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .game-over-modal.show {
            display: flex;
        }

        .game-over-box {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            text-align: center;
            max-width: 500px;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .game-over-box h2 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
            margin-top: 0;
        }

        .game-over-box .result {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .game-over-box .reason {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .square {
                font-size: 30px;
            }

            .piece {
                font-size: 40px;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <span class="connection-dot"></span>
        <span id="connectionText">Connecting...</span>
    </div>

    <div class="promotion-modal" id="promotionModal">
        <div class="promotion-box">
            <h2>Pawn Promotion</h2>
            <p style="margin-bottom: 20px; color: #666;">Choose a piece:</p>
            <div class="promotion-options">
                <div class="promotion-piece" onclick="completePromotion('q')">‚ôï</div>
                <div class="promotion-piece" onclick="completePromotion('r')">‚ôñ</div>
                <div class="promotion-piece" onclick="completePromotion('b')">‚ôó</div>
                <div class="promotion-piece" onclick="completePromotion('n')">‚ôò</div>
            </div>
        </div>
    </div>

    <div class="game-over-modal" id="gameOverModal">
        <div class="game-over-box">
            <h2 id="gameOverTitle">Game Over</h2>
            <div class="result" id="gameOverResult">White Wins!</div>
            <div class="reason" id="gameOverReason">Checkmate</div>
            <div class="game-over-buttons">
                <button class="btn-primary" onclick="newGame()">üîÑ New Game</button>
                <button class="btn-secondary" onclick="closeGameOverModal()">üìä Review</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>‚ôü Chess AI - AlphaZero ‚ôü</h1>

        <div class="board-section">
            <div class="timer" id="blackTimerContainer">
                <span>ü§ñ AI (Black)</span> | <span id="blackTimer">10:00</span>
            </div>
            <div class="board-wrapper">
                <div class="chess-board" id="board"></div>
            </div>
            <div class="timer" id="whiteTimerContainer">
                <span>üë§ You (White)</span> | <span id="whiteTimer">10:00</span>
            </div>
            <div id="statusMessage" class="status"></div>
        </div>

        <div class="side-panel">
            <div class="panel">
                <h3>üéÆ Game Mode</h3>
                <div class="mode-selector">
                    <button class="btn-success" onclick="startGame('pve', 'black')">‚ñ∂ Play vs AI</button>
                    <button class="btn-secondary" onclick="startGame('pvp', 'white')">üë• 2 Player</button>
                </div>
            </div>

            <div class="panel">
                <h3>‚öôÔ∏è Controls</h3>
                <div class="controls">
                    <button class="btn-primary" onclick="newGame()">üîÑ New Game</button>
                    <button class="btn-secondary" onclick="undoMove()">‚Ü∂ Undo</button>
                    <button class="btn-danger" onclick="resignGame()">üè≥ Resign</button>
                </div>
            </div>

            <div class="panel">
                <h3>üìä Game Statistics</h3>
                <div class="stat-item">
                    <span class="stat-label">Mode:</span>
                    <span class="stat-value" id="gameMode">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Moves:</span>
                    <span class="stat-value" id="moveCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Current Turn:</span>
                    <span class="stat-value" id="currentTurn">White</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="gameStatus">‚è≥ Ready</span>
                </div>
            </div>

            <div class="panel">
                <h3>üìù Move History</h3>
                <div class="move-history" id="moveHistory">
                    <em>No moves yet</em>
                </div>
            </div>

            <div class="panel">
                <h3>üß† AlphaZero Engine</h3>
                <div class="stat-item">
                    <span class="stat-label">Model:</span>
                    <span class="stat-value">CNN + MCTS</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Simulations:</span>
                    <span class="stat-value">200/move</span>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 12px; line-height: 1.5;">
                    ‚ú® Deep reinforcement learning with Monte Carlo Tree Search. Real-time inference on GPU.
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== PIECE SYMBOLS ====================
        const PIECE_SYMBOLS = {
            'P': '‚ôô', 'N': '‚ôò', 'B': '‚ôó', 'R': '‚ôñ', 'Q': '‚ôï', 'K': '‚ôî',
            'p': '‚ôü', 'n': '‚ôû', 'b': '‚ôù', 'r': '‚ôú', 'q': '‚ôõ', 'k': '‚ôö'
        };

        // ==================== GLOBAL STATE ====================
        let gameState = {
            gameId: null,
            mode: null,
            aiSide: null,
            board: null,
            legalMoves: [],
            selectedSquare: null,
            lastMove: null,
            moves: [],
            isGameOver: false,
            turn: 'white',
            whiteTime: 600,
            blackTime: 600
        };

        let socket = null;
        let socketConnected = false;
        let promotionData = null;
        let timerInterval = null;

        // ==================== TIMER SYSTEM ====================
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (gameState.isGameOver) {
                    clearInterval(timerInterval);
                    return;
                }

                if (gameState.turn === 'white') {
                    gameState.whiteTime--;
                    if (gameState.whiteTime <= 0) {
                        gameState.whiteTime = 0;
                        endGameTimeout('white');
                        return;
                    }
                } else {
                    gameState.blackTime--;
                    if (gameState.blackTime <= 0) {
                        gameState.blackTime = 0;
                        endGameTimeout('black');
                        return;
                    }
                }
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerDisplay() {
            const whiteEl = document.getElementById('whiteTimer');
            const blackEl = document.getElementById('blackTimer');
            const whiteContainer = document.getElementById('whiteTimerContainer');
            const blackContainer = document.getElementById('blackTimerContainer');

            whiteEl.textContent = formatTime(gameState.whiteTime);
            blackEl.textContent = formatTime(gameState.blackTime);

            // Add warning class if time low
            if (gameState.whiteTime <= 30) {
                whiteContainer.classList.add('warning');
            } else {
                whiteContainer.classList.remove('warning');
            }

            if (gameState.blackTime <= 30) {
                blackContainer.classList.add('warning');
            } else {
                blackContainer.classList.remove('warning');
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function endGameTimeout(player) {
            stopTimer();
            gameState.isGameOver = true;
            const loser = player === 'white' ? 'White' : 'Black';
            const winner = player === 'white' ? 'Black' : 'White';
            
            showGameOverModal(
                `‚è∞ Time's Up!`,
                `${winner} Wins!`,
                `${loser} ran out of time`
            );
            showStatus(`‚è∞ ${loser} ran out of time - ${winner} wins!`, 'warning');
        }

        // ==================== SOCKET INITIALIZATION ====================
        function initSocket() {
            console.log('[Socket] Initializing socket.io connection...');
            socket = io();

            socket.on('connect', () => {
                console.log('[Socket] ‚úÖ Connected to server');
                socketConnected = true;
                updateConnectionStatus(true);
                showStatus('Connected to AlphaZero server ‚úÖ', 'success');
            });

            socket.on('disconnect', () => {
                console.log('[Socket] ‚ùå Disconnected from server');
                socketConnected = false;
                stopTimer();
                updateConnectionStatus(false);
                showStatus('Disconnected from server ‚ùå', 'error');
            });

            socket.on('game_created', (data) => {
                console.log('[Game] game_created event received:', data);
                gameState.gameId = data.game_id;
                gameState.mode = data.mode;
                gameState.aiSide = data.ai_side;
                gameState.board = data.board_fen;
                gameState.legalMoves = data.legal_moves;
                gameState.moves = data.moves || [];
                gameState.turn = data.turn;
                gameState.isGameOver = data.is_over;
                gameState.selectedSquare = null;
                gameState.whiteTime = 600;
                gameState.blackTime = 600;
                
                closeGameOverModal();
                startTimer();
                updateUI();
                const modeText = data.mode === 'pve' ? 'Human vs AI' : '2 Player';
                showStatus(`üéÆ Game started! Mode: ${modeText}`, 'success');
            });

            socket.on('move_made', (data) => {
                console.log('[Game] move_made event received:', data);
                gameState.board = data.board_fen;
                gameState.legalMoves = data.legal_moves;
                gameState.moves = data.moves || [];
                gameState.lastMove = data.move;
                gameState.turn = data.turn;
                gameState.isGameOver = data.is_over;
                gameState.selectedSquare = null;
                
                updateUI();
            });

            socket.on('ai_thinking', (data) => {
                console.log('[AI] AI is thinking...');
                showStatus('ü§ñ AI is thinking... ‚è≥', 'info');
            });

            socket.on('ai_move', (data) => {
                console.log('[AI] ai_move event received:', data);
                gameState.board = data.board_fen;
                gameState.legalMoves = data.legal_moves;
                gameState.moves = data.moves || [];
                gameState.lastMove = data.move;
                gameState.turn = data.turn;
                gameState.isGameOver = data.is_over;
                gameState.selectedSquare = null;
                
                const moveStr = `${data.move.substring(0, 2).toUpperCase()}-${data.move.substring(2, 4).toUpperCase()}`;
                showStatus(`ü§ñ AI moved: ${moveStr}`, 'success');
                updateUI();

                if (data.is_over) {
                    handleGameEnd(data);
                }
            });

            socket.on('game_over', (data) => {
                console.log('[Game] game_over event received:', data);
                gameState.isGameOver = true;
                gameState.board = data.board_fen;
                gameState.turn = data.turn;
                
                handleGameEnd(data);
                updateUI();
            });

            socket.on('move_undone', (data) => {
                console.log('[Game] move_undone event received:', data);
                gameState.board = data.board_fen;
                gameState.legalMoves = data.legal_moves;
                gameState.moves = data.moves || [];
                gameState.lastMove = data.last_move || null;
                gameState.turn = data.turn;
                gameState.isGameOver = data.is_over;
                gameState.selectedSquare = null;
                
                showStatus('‚Ü∂ Last 2 moves undone', 'info');
                updateUI();
            });

            socket.on('illegal_move', (data) => {
                console.log('[Game] Illegal move:', data);
                showStatus(`‚ùå Illegal move: ${data.move}`, 'error');
                gameState.selectedSquare = null;
                renderBoard();
            });

            socket.on('error', (data) => {
                console.error('[Game] Error:', data);
                showStatus(`‚ùå ${data.message}`, 'error');
            });
        }

        // ==================== GAME LOGIC ====================

        function startGame(mode, aiSide) {
            console.log('[Game] Starting game:', mode, aiSide);
            if (!socketConnected) {
                showStatus('‚ùå Not connected to server', 'error');
                return;
            }

            socket.emit('new_game', {
                mode: mode,
                ai_side: aiSide
            });
        }

        function newGame() {
            console.log('[Game] New game button clicked');
            stopTimer();
            gameState = {
                gameId: null,
                mode: null,
                aiSide: null,
                board: null,
                legalMoves: [],
                selectedSquare: null,
                lastMove: null,
                moves: [],
                isGameOver: false,
                turn: 'white',
                whiteTime: 600,
                blackTime: 600
            };
            hidePromotionModal();
            closeGameOverModal();
            updateUI();
        }

        function makeMove(from, to) {
            if (!gameState.gameId) {
                showStatus('‚ùå No active game', 'error');
                return;
            }

            if (!socketConnected) {
                showStatus('‚ùå Not connected to server', 'error');
                return;
            }

            // Get the piece at the from square
            const fenParts = gameState.board.split(' ');
            const position = fenParts[0];
            const ranks = position.split('/');
            const fromFile = from.charCodeAt(0) - 97;
            const fromRank = 8 - parseInt(from[1]);
            
            let piece = '';
            let fileCount = 0;
            const rankStr = ranks[fromRank];
            
            for (let i = 0; i < rankStr.length; i++) {
                const char = rankStr[i];
                if (/\d/.test(char)) {
                    fileCount += parseInt(char);
                } else {
                    if (fileCount === fromFile) {
                        piece = char;
                        break;
                    }
                    fileCount++;
                }
            }
            
            // Check for promotion
            const toRank = parseInt(to[1]);
            const fromRankNum = parseInt(from[1]);
            
            if ((piece === 'P' && toRank === 8 && fromRankNum === 7) || 
                (piece === 'p' && toRank === 1 && fromRankNum === 2)) {
                promotionData = { from, to };
                showPromotionModal();
                return;
            }

            const move = from + to;
            console.log('[Game] Making move:', move);

            socket.emit('player_move', {
                game_id: gameState.gameId,
                move: move
            });
        }

        function completePromotion(piece) {
            if (!promotionData) return;
            
            const { from, to } = promotionData;
            const move = from + to + piece;
            console.log('[Promotion] Completed with piece:', piece, 'Move:', move);
            
            hidePromotionModal();
            promotionData = null;
            
            socket.emit('player_move', {
                game_id: gameState.gameId,
                move: move
            });
        }

        function undoMove() {
            if (!gameState.gameId) {
                showStatus('‚ùå No active game', 'error');
                return;
            }

            if (!socketConnected) {
                showStatus('‚ùå Not connected to server', 'error');
                return;
            }

            if (gameState.moves.length < 2) {
                showStatus('‚ùå At least 2 moves required to undo', 'error');
                return;
            }

            console.log('[Game] Undoing move');
            socket.emit('undo_move', {
                game_id: gameState.gameId
            });
        }

        function resignGame() {
            if (!gameState.gameId) {
                showStatus('‚ùå No active game', 'error');
                return;
            }

            if (!socketConnected) {
                showStatus('‚ùå Not connected to server', 'error');
                return;
            }

            if (confirm('Resign game? You will lose.')) {
                console.log('[Game] Resigning game');
                stopTimer();
                socket.emit('resign', {
                    game_id: gameState.gameId,
                    player: 'white'
                });
            }
        }

        function handleGameEnd(data) {
            console.log('[Game] Game ended:', data);
            stopTimer();
            const reason = data.game_ending_reason || data.reason || 'unknown';
            
            let title = 'Game Over';
            let result = 'Draw';
            let message = '';

            switch(reason) {
                case 'checkmate':
                    title = 'üèÜ Checkmate!';
                    result = `${data.winner} Wins!`;
                    message = 'Checkmate - Game Over';
                    break;
                case 'stalemate':
                    title = 'ü§ù Stalemate';
                    result = 'Draw';
                    message = 'Stalemate - Game is a draw';
                    break;
                case 'insufficient_material':
                    title = 'ü§ù Draw';
                    result = 'Draw';
                    message = 'Insufficient material - Game is a draw';
                    break;
                case 'resignation':
                    title = 'üè≥ Resignation';
                    result = `${data.reason}`;
                    message = `Opponent resigned`;
                    break;
                default:
                    title = 'Game Over';
                    result = data.message || 'Game Over';
                    message = data.message || 'Game Over';
            }
            
            showGameOverModal(title, result, message);
            showStatus(`${title} - ${message}`, 'warning');
        }

        // ==================== UI RENDERING ====================

        function updateUI() {
            renderBoard();
            updateStats();
            updateMoveHistory();
            updateTimerDisplay();
        }

        function renderBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';

            if (!gameState.board) {
                const placeholder = document.createElement('div');
                placeholder.style.gridColumn = '1/-1';
                placeholder.style.textAlign = 'center';
                placeholder.style.padding = '50px';
                placeholder.style.color = '#999';
                placeholder.textContent = 'Select a game mode to start playing';
                board.appendChild(placeholder);
                return;
            }

            const fenParts = gameState.board.split(' ');
            const position = fenParts[0];
            const ranks = position.split('/');

            let squareIndex = 0;
            for (let rank = 0; rank < 8; rank++) {
                const rankStr = ranks[rank];
                let file = 0;

                for (let i = 0; i < rankStr.length; i++) {
                    const char = rankStr[i];

                    if (/\d/.test(char)) {
                        for (let j = 0; j < parseInt(char); j++) {
                            createSquare(board, file, rank, '', squareIndex++);
                            file++;
                        }
                    } else {
                        createSquare(board, file, rank, char, squareIndex++);
                        file++;
                    }
                }
            }
        }

        function createSquare(board, file, rank, piece, index) {
            const square = document.createElement('div');
            square.className = 'square';
            const squareName = String.fromCharCode(97 + file) + (8 - rank);
            square.id = squareName;

            if (gameState.lastMove && 
                (squareName === gameState.lastMove.substring(0, 2) || 
                 squareName === gameState.lastMove.substring(2, 4))) {
                square.classList.add('last-move');
            }

            if (gameState.selectedSquare === squareName) {
                square.classList.add('selected');
            }

            if (gameState.selectedSquare) {
                const possibleMoves = gameState.legalMoves.filter(m => m.startsWith(gameState.selectedSquare));
                possibleMoves.forEach(move => {
                    if (squareName === move.substring(2, 4)) {
                        square.classList.add('legal-move');
                    }
                });
            }

            if (piece) {
                const pieceElement = document.createElement('div');
                pieceElement.className = 'piece';
                const isWhite = piece === piece.toUpperCase();
                pieceElement.classList.add(isWhite ? 'white' : 'black');
                pieceElement.textContent = PIECE_SYMBOLS[piece] || piece;
                square.appendChild(pieceElement);
            }

            square.onclick = () => handleSquareClick(squareName);
            board.appendChild(square);
        }

        function handleSquareClick(squareName) {
            if (!gameState.gameId || gameState.isGameOver) {
                return;
            }

            if (gameState.selectedSquare === null) {
                if (gameState.legalMoves.some(m => m.startsWith(squareName))) {
                    gameState.selectedSquare = squareName;
                    renderBoard();
                    return;
                }
            } else {
                const move = gameState.selectedSquare + squareName;
                if (gameState.legalMoves.includes(move) || 
                    gameState.legalMoves.some(m => m.startsWith(move))) {
                    makeMove(gameState.selectedSquare, squareName);
                    gameState.selectedSquare = null;
                } else {
                    gameState.selectedSquare = null;
                    if (gameState.legalMoves.some(m => m.startsWith(squareName))) {
                        gameState.selectedSquare = squareName;
                    }
                    renderBoard();
                }
            }
        }

        function updateStats() {
            document.getElementById('gameMode').textContent = gameState.mode ? (gameState.mode === 'pve' ? 'Human vs AI' : '2 Player') : '-';
            document.getElementById('moveCount').textContent = gameState.moves.length;
            document.getElementById('currentTurn').textContent = gameState.turn === 'white' ? 'üë§ White' : 'ü§ñ Black';
            document.getElementById('gameStatus').textContent = gameState.isGameOver ? '‚úÖ Game Over' : 'üîÑ In Progress';
        }

        function updateMoveHistory() {
            const history = document.getElementById('moveHistory');
            if (gameState.moves.length === 0) {
                history.innerHTML = '<em>No moves yet</em>';
                return;
            }

            history.innerHTML = gameState.moves.map((move, idx) => {
                const moveStr = `${move.substring(0, 2).toUpperCase()}-${move.substring(2, 4).toUpperCase()}`;
                const moveType = idx % 2 === 0 ? 'üë§' : 'ü§ñ';
                return `<div class="move-item">${moveType} ${idx + 1}. ${moveStr}</div>`;
            }).join('');

            history.scrollTop = history.scrollHeight;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status show ${type}`;
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 5000);
            }
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            if (connected) {
                statusEl.className = 'connection-status connected';
                textEl.textContent = 'üü¢ Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                textEl.textContent = 'üî¥ Disconnected';
            }
        }

        function showPromotionModal() {
            document.getElementById('promotionModal').classList.add('show');
        }

        function hidePromotionModal() {
            document.getElementById('promotionModal').classList.remove('show');
        }

        function showGameOverModal(title, result, reason) {
            document.getElementById('gameOverTitle').textContent = title;
            document.getElementById('gameOverResult').textContent = result;
            document.getElementById('gameOverReason').textContent = reason;
            document.getElementById('gameOverModal').classList.add('show');
        }

        function closeGameOverModal() {
            document.getElementById('gameOverModal').classList.remove('show');
        }

        // ==================== INITIALIZATION ====================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[Init] Page loaded, initializing socket.io...');
            initSocket();
            updateConnectionStatus(false);
            renderBoard();
        });
    </script>
</body>
</html>